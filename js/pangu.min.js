/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/pangu@7.2.0/dist/browser/pangu.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,i);import{Pangu}from"../shared/index.js";class DomWalker{static collectTextNodes(e,t=!1){const i=[];if(!e||e instanceof DocumentFragment)return i;const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>{if(!e.nodeValue||!/\S/.test(e.nodeValue))return NodeFilter.FILTER_REJECT;let t=e;for(;t;){if(t instanceof Element){if(this.ignoredTags.test(t.nodeName))return NodeFilter.FILTER_REJECT;if(this.isContentEditable(t))return NodeFilter.FILTER_REJECT;if(t.classList.contains(this.ignoredClass))return NodeFilter.FILTER_REJECT}t=t.parentNode}return NodeFilter.FILTER_ACCEPT}});for(;s.nextNode();)i.push(s.currentNode);return t?i.reverse():i}static canIgnoreNode(e){let t=e;if(t&&(this.isSpecificTag(t,this.ignoredTags)||this.isContentEditable(t)||this.hasIgnoredClass(t)))return!0;for(;t.parentNode;)if(t=t.parentNode,t&&(this.isSpecificTag(t,this.ignoredTags)||this.isContentEditable(t)))return!0;return!1}static isFirstTextChild(e,t){const{childNodes:i}=e;for(let e=0;e<i.length;e++){const s=i[e];if(s.nodeType!==Node.COMMENT_NODE&&s.textContent)return s===t}return!1}static isLastTextChild(e,t){const{childNodes:i}=e;for(let e=i.length-1;e>-1;e--){const s=i[e];if(s.nodeType!==Node.COMMENT_NODE&&s.textContent)return s===t}return!1}static isSpecificTag(e,t){return!!(e&&e.nodeName&&t.test(e.nodeName))}static isContentEditable(e){return e instanceof HTMLElement&&(e.isContentEditable||"true"===e.getAttribute("g_editable"))}static hasIgnoredClass(e){return!!(e instanceof Element&&e.classList.contains(this.ignoredClass))||!!(e.parentNode&&e.parentNode instanceof Element&&e.parentNode.classList.contains(this.ignoredClass))}}__publicField(DomWalker,"blockTags",/^(div|p|h1|h2|h3|h4|h5|h6)$/i),__publicField(DomWalker,"ignoredTags",/^(code|pre|script|style|textarea|iframe|input)$/i),__publicField(DomWalker,"presentationalTags",/^(b|code|del|em|i|s|strong|kbd)$/i),__publicField(DomWalker,"spaceLikeTags",/^(br|hr|i|img|pangu)$/i),__publicField(DomWalker,"spaceSensitiveTags",/^(a|del|pre|s|strike|u)$/i),__publicField(DomWalker,"ignoredClass","no-pangu-spacing");class TaskQueue{constructor(){__publicField(this,"queue",[]),__publicField(this,"isProcessing",!1),__publicField(this,"onComplete")}add(e){this.queue.push(e),this.scheduleProcessing()}clear(){this.queue.length=0,this.onComplete=void 0}setOnComplete(e){this.onComplete=e}get length(){return this.queue.length}scheduleProcessing(){!this.isProcessing&&this.queue.length>0&&(this.isProcessing=!0,requestIdleCallback((e=>this.process(e)),{timeout:5e3}))}process(e){for(var t;e.timeRemaining()>0&&this.queue.length>0;){const e=this.queue.shift();null==e||e()}this.isProcessing=!1,this.queue.length>0?this.scheduleProcessing():null==(t=this.onComplete)||t.call(this)}}class TaskScheduler{constructor(){__publicField(this,"config",{enabled:!0,chunkSize:40,timeout:2e3}),__publicField(this,"taskQueue",new TaskQueue)}get queue(){return this.taskQueue}processInChunks(e,t,i){if(!this.config.enabled)return t(e),void(null==i||i());if(0===e.length)return void(null==i||i());i&&this.taskQueue.setOnComplete(i);const s=[];for(let t=0;t<e.length;t+=this.config.chunkSize)s.push(e.slice(t,t+this.config.chunkSize));for(const e of s)this.taskQueue.add((()=>{t(e)}))}clear(){this.taskQueue.clear()}updateConfig(e){Object.assign(this.config,e)}}class VisibilityDetector{constructor(){__publicField(this,"config",{enabled:!0,commonHiddenPatterns:{clipRect:!0,displayNone:!0,visibilityHidden:!0,opacityZero:!0,heightWidth1px:!0}})}isElementVisuallyHidden(e){if(!this.config.enabled)return!1;const t=getComputedStyle(e),i=this.config.commonHiddenPatterns;if(i.displayNone&&"none"===t.display)return!0;if(i.visibilityHidden&&"hidden"===t.visibility)return!0;if(i.opacityZero&&0===parseFloat(t.opacity))return!0;if(i.clipRect){const e=t.clip;if(e&&(e.includes("rect(1px, 1px, 1px, 1px)")||e.includes("rect(0px, 0px, 0px, 0px)")||e.includes("rect(0, 0, 0, 0)")))return!0}if(i.heightWidth1px){const e=parseInt(t.height,10),i=parseInt(t.width,10);if(1===e&&1===i){const e=t.overflow,i=t.position;if("hidden"===e&&"absolute"===i)return!0}}return!1}shouldSkipSpacingAfterNode(e){if(!this.config.enabled)return!1;let t=null;if(e instanceof Element?t=e:e.parentElement&&(t=e.parentElement),t&&this.isElementVisuallyHidden(t))return!0;let i=null==t?void 0:t.parentElement;for(;i;){if(this.isElementVisuallyHidden(i))return!0;i=i.parentElement}return!1}shouldSkipSpacingBeforeNode(e){if(!this.config.enabled)return!1;let t=e.previousSibling;if(!t&&e.parentElement){let i=e.parentElement;for(;i&&!t;)t=i.previousSibling,t||(i=i.parentElement)}if(t){if(t instanceof Element&&this.isElementVisuallyHidden(t))return!0;if(t instanceof Text&&t.parentElement&&this.isElementVisuallyHidden(t.parentElement))return!0}return!1}updateConfig(e){Object.assign(this.config,e),e.commonHiddenPatterns&&Object.assign(this.config.commonHiddenPatterns,e.commonHiddenPatterns)}}function once(e){let t=!1;return function(...i){if(!t)return t=!0,e(...i)}}function debounce(e,t,i=1/0){let s=null,n=null;return function(...o){const a=Date.now();s&&clearTimeout(s),n||(n=a),a-n>=i?(e(...o),n=a):s=window.setTimeout((()=>{e(...o)}),t)}}class BrowserPangu extends Pangu{constructor(){super(...arguments),__publicField(this,"isAutoSpacingPageExecuted",!1),__publicField(this,"autoSpacingPageObserver",null),__publicField(this,"taskScheduler",new TaskScheduler),__publicField(this,"visibilityDetector",new VisibilityDetector)}autoSpacingPage({pageDelayMs:e=1e3,nodeDelayMs:t=500,nodeMaxWaitMs:i=2e3}={}){document.body instanceof Node&&(this.isAutoSpacingPageExecuted||(this.isAutoSpacingPageExecuted=!0,this.waitForVideosToLoad(e,once((()=>this.spacingPage()))),this.setupAutoSpacingPageObserver(t,i)))}spacingPage(){const e=document.querySelector("head > title");e&&this.spacingNode(e),this.spacingNode(document.body)}spacingNode(e){const t=DomWalker.collectTextNodes(e,!0);this.taskScheduler.config.enabled?this.spacingTextNodesInQueue(t):this.spacingTextNodes(t)}stopAutoSpacingPage(){this.autoSpacingPageObserver&&(this.autoSpacingPageObserver.disconnect(),this.autoSpacingPageObserver=null),this.isAutoSpacingPageExecuted=!1}isElementVisuallyHidden(e){return this.visibilityDetector.isElementVisuallyHidden(e)}spacingTextNodes(e){let t,i=null;for(let s=0;s<e.length;s++)if(t=e[s],t)if(DomWalker.canIgnoreNode(t))i=t;else{if(t instanceof Text)if(this.visibilityDetector.config.enabled&&t.data.startsWith(" ")&&this.visibilityDetector.shouldSkipSpacingBeforeNode(t)&&(t.data=t.data.substring(1)),1===t.data.length&&/["\u201c\u201d]/.test(t.data)){if(t.previousSibling){const e=t.previousSibling;if(e.nodeType===Node.ELEMENT_NODE&&e.textContent){const i=e.textContent.slice(-1);/[\u4e00-\u9fff]/.test(i)&&(t.data=` ${t.data}`)}}}else{const e=this.spacingText(t.data);t.data!==e&&(t.data=e)}if(i){if(t.nextSibling&&DomWalker.spaceLikeTags.test(t.nextSibling.nodeName)){i=t;continue}if(!(t instanceof Text&&i instanceof Text))continue;const e=t.data.endsWith(" "),s=i.data.startsWith(" ");let n=!1,o=t;for(;o.parentNode&&DomWalker.isLastTextChild(o.parentNode,o)&&!DomWalker.spaceSensitiveTags.test(o.parentNode.nodeName);)o=o.parentNode;let a=i;for(;a.parentNode&&DomWalker.isFirstTextChild(a.parentNode,a)&&!DomWalker.spaceSensitiveTags.test(a.parentNode.nodeName);)a=a.parentNode;let r=o.nextSibling;for(;r&&r!==a;){if(r.nodeType===Node.TEXT_NODE&&r.textContent&&/\s/.test(r.textContent)){n=!0;break}r=r.nextSibling}if(e||s||n){i=t;continue}const l=t.data.slice(-1)+i.data.slice(0,1),d=this.spacingText(l),c=t.data.slice(-1),u=i.data.slice(0,1),p=e=>/["\u201c\u201d]/.test(e),h=e=>/[\u4e00-\u9fff]/.test(e),g=p(c)&&h(u)||h(c)&&p(u);if(d!==l&&!g){let e=i;for(;e.parentNode&&!DomWalker.spaceSensitiveTags.test(e.nodeName)&&DomWalker.isFirstTextChild(e.parentNode,e);)e=e.parentNode;let s=t;for(;s.parentNode&&!DomWalker.spaceSensitiveTags.test(s.nodeName)&&DomWalker.isLastTextChild(s.parentNode,s);)s=s.parentNode;if(s.nextSibling&&DomWalker.spaceLikeTags.test(s.nextSibling.nodeName)){i=t;continue}if(!DomWalker.blockTags.test(s.nodeName))if(DomWalker.spaceSensitiveTags.test(e.nodeName))if(DomWalker.spaceSensitiveTags.test(s.nodeName)){if(!this.visibilityDetector.shouldSkipSpacingAfterNode(t)){const t=document.createElement("pangu");t.innerHTML=" ",e.parentNode&&(e.previousSibling&&DomWalker.spaceLikeTags.test(e.previousSibling.nodeName)||e.parentNode.insertBefore(t,e)),t.previousElementSibling||t.parentNode&&t.parentNode.removeChild(t)}}else t instanceof Text&&!t.data.endsWith(" ")&&(this.visibilityDetector.shouldSkipSpacingAfterNode(t)||(t.data=`${t.data} `));else DomWalker.ignoredTags.test(e.nodeName)||DomWalker.blockTags.test(e.nodeName)||(i.previousSibling?DomWalker.spaceLikeTags.test(i.previousSibling.nodeName)||i instanceof Text&&!i.data.startsWith(" ")&&(this.visibilityDetector.shouldSkipSpacingBeforeNode(i)||(i.data=` ${i.data}`)):DomWalker.canIgnoreNode(i)||i instanceof Text&&!i.data.startsWith(" ")&&(this.visibilityDetector.shouldSkipSpacingBeforeNode(i)||(i.data=` ${i.data}`)))}}i=t}}spacingTextNodesInQueue(e,t){if(this.visibilityDetector.config.enabled)return void(this.taskScheduler.config.enabled?(this.taskScheduler.queue.add((()=>{this.spacingTextNodes(e)})),t&&this.taskScheduler.queue.setOnComplete(t)):(this.spacingTextNodes(e),null==t||t()));this.taskScheduler.processInChunks(e,(e=>this.spacingTextNodes(e)),t)}waitForVideosToLoad(e,t){const i=Array.from(document.getElementsByTagName("video"));if(0===i.length)setTimeout(t,e);else{if(i.every((e=>e.readyState>=3)))setTimeout(t,e);else{let s=0;const n=i.length,o=()=>{s++,s>=n&&setTimeout(t,e)};for(const e of i)e.readyState>=3?o():e.addEventListener("loadeddata",o,{once:!0});setTimeout(t,e+5e3)}}}setupAutoSpacingPageObserver(e,t){this.autoSpacingPageObserver&&(this.autoSpacingPageObserver.disconnect(),this.autoSpacingPageObserver=null);const i=[],s=debounce((()=>{const e=document.querySelector("head > title");e&&this.spacingNode(e)}),e,t),n=debounce((()=>{if(this.taskScheduler.config.enabled){const e=[...i];if(i.length=0,e.length>0){const t=[];for(const i of e){const e=DomWalker.collectTextNodes(i,!0);t.push(...e)}this.spacingTextNodesInQueue(t)}}else for(;i.length;){const e=i.shift();e&&this.spacingNode(e)}}),e,t);this.autoSpacingPageObserver=new MutationObserver((e=>{var t;let o=!1;for(const s of e)if("TITLE"!==(null==(t=s.target.parentNode)?void 0:t.nodeName)&&"TITLE"!==s.target.nodeName)switch(s.type){case"characterData":const{target:e}=s;e.nodeType===Node.TEXT_NODE&&e.parentNode&&i.push(e.parentNode);break;case"childList":for(const e of s.addedNodes)e.nodeType===Node.ELEMENT_NODE?i.push(e):e.nodeType===Node.TEXT_NODE&&e.parentNode&&i.push(e.parentNode)}else o=!0;o&&s(),n()})),this.autoSpacingPageObserver.observe(document.head,{characterData:!0,childList:!0,subtree:!0}),this.autoSpacingPageObserver.observe(document.body,{characterData:!0,childList:!0,subtree:!0})}}const pangu=new BrowserPangu;export{BrowserPangu,pangu as default,pangu};
//# sourceMappingURL=/sm/c524d08ec84084950576a3d567df91146b6e2adb77b2f2ec19c55309c4612cda.map